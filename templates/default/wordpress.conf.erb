<VirtualHost *:80>
  ServerName <%= @params[:server_name] %>
  <% Chef::Log.debug("TODO: Remove me from template wordpress.conf.erb: template @params are: #{@params.inspect}") %>
  <% if !(@params[:server_aliases].nil?) && @params.length > 0 %>
  ServerAlias <% @params[:server_aliases].each do |a| %><%= a %> <% end %>
  <% end %>
  DocumentRoot <%= @params[:docroot] %>

  <Directory <%= @params[:docroot] %>>
    Options FollowSymLinks
    AllowOverride FileInfo Options
    Order allow,deny
    Allow from all
  </Directory>

  <Directory />
    Options FollowSymLinks
    AllowOverride None
  </Directory>

  LogLevel info
  ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-error.log
  CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-access.log combined

  Include <%= node[:apache][:dir] %>/sites-available/<%= @params[:name] %>.conf.inc

  RewriteEngine On
  RewriteLog <%= node['apache']['log_dir'] %>/<%= @application_name %>-rewrite.log
  RewriteLogLevel 0
  Include <%= node[:apache][:dir] %>/sites-available/<%= @params[:name] %>.conf.rewrite.inc
</VirtualHost>

<VirtualHost *:443>

  SSLEngine On
  SSLCertificateFile    /etc/ssl/certs/ssl-cert-snakeoil.pem
  SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
  
  ServerName <%= @params[:server_name] %>
  ServerAlias <% @params[:server_aliases].each do |a| %><%= a %> <% end %>
  DocumentRoot <%= @params[:docroot] %>

  <Directory <%= @params[:docroot] %>>
    Options FollowSymLinks
    AllowOverride FileInfo Options
    Order allow,deny
    Allow from all
  </Directory>

  <Directory />
    Options FollowSymLinks
    AllowOverride None
  </Directory>

<% if @params[:admin_ips].length > 0 && @params[:admin_ips].first.downcase != "all" %>
  ## Restrict WordPress Login Pages to My IPs ##
  <Files wp-login.php>
    order deny,allow
    deny from all
  <% @params[:admin_ips].each do |ip| %>
    Allow from <%= ip %>
  <% end %>
  </Files>
  <Files login>
    order deny,allow
    deny from all
  <% @params[:admin_ips].each do |ip| %>
    Allow from <%= ip %>
  <% end %>
  </Files>
<% end %>

  LogLevel info
  ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-https-error.log
  CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-https-access.log combined

  Include <%= node[:apache][:dir] %>/sites-available/<%= @params[:name] %>.conf.inc
  
  RewriteEngine On
  RewriteLog <%= node['apache']['log_dir'] %>/<%= @application_name %>-https-rewrite.log
  RewriteLogLevel 0
  Include <%= node[:apache][:dir] %>/sites-available/<%= @params[:name] %>.conf.rewrite.inc
  
</VirtualHost>
